@using Newtonsoft.Json
@model dynamic

@{
    ViewData["Title"] = "Chi ti·∫øt tr·∫°m l∆∞·ª£ng m∆∞a";

    // H√†m l·∫•y m√†u theo m·ª©c ƒë·ªô m∆∞a
    string GetRainColor(double rain)
    {
        if (rain > 100) return "#FF0000";      // M∆∞a r·∫•t to - ƒë·ªè
        if (rain > 50)  return "#FFA500";      // M∆∞a to - cam
        if (rain > 10)  return "#32CD32";      // M∆∞a v·ª´a - xanh l√°
        if (rain > 0)   return "#87CEFA";      // M∆∞a nh·ªè - xanh bi·ªÉn nh·∫°t
        return "#2F4F4F";                      // Kh√¥ng m∆∞a - ƒëen kh√≥i
    }

    string GetRainLevel(double rain)
    {
        if (rain > 100) return "R·∫§T TO";
        if (rain > 50)  return "TO";
        if (rain > 10)  return "V·ª™A";
        if (rain > 0)   return "NH·ªé";
        return "KH√îNG M∆ØA";
    }
}

<div class="text-center mb-4">
    <h2 class="text-primary fw-bold">üåß CHI TI·∫æT L∆Ø·ª¢NG M∆ØA KHU V·ª∞C</h2>
</div>

<!-- FORM L·ªåC -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white fw-bold">üîç L·ªåC D·ªÆ LI·ªÜU</div>
    <div class="card-body">
        <form asp-action="Index" method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label fw-bold">Tr·∫°m:</label>
                    <select name="matram" class="form-select form-select-lg" onchange="this.form.submit()">
                        <option value="">-- Ch·ªçn tr·∫°m --</option>
                        @if (ViewBag.Trams != null)
                        {
                            foreach (var tram in ViewBag.Trams as List<KttvKvtnWeb.Models.TramKttvtn>)
                            {
                                if (ViewBag.MaTram == tram.Matram)
                                {
                                    <option selected value="@tram.Matram">@tram.Tentram</option>
                                }
                                else
                                {
                                    <option value="@tram.Matram">@tram.Tentram</option>
                                }
                            }
                        }
                    </select>

                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">T·ª´:</label>
                    <input type="date" name="from" class="form-control" value="@ViewBag.FromDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ƒê·∫øn:</label>
                    <input type="date" name="to" class="form-control" value="@ViewBag.ToDate" />
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">T√¨m</button>
                </div>
            </div>
        </form>
    </div>
</div>

@if (ViewBag.Data != null && ViewBag.Data.Count > 0)
{
    <!-- BI·ªÇU ƒê·ªí LINE CHART -->
    <div class="card mt-4">
        <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
            <span>üìà @ViewBag.TenTram (@ViewBag.Data.Count b·∫£n ghi)</span>
            <a asp-action="ExportExcel" 
               asp-route-matram="@ViewBag.MaTram" 
               asp-route-from="@ViewBag.FromDate" 
               asp-route-to="@ViewBag.ToDate" 
               class="btn btn-success btn-lg">üì• XU·∫§T EXCEL</a>
        </div>
        <div class="card-body">
            <canvas id="lineChart" height="120"></canvas>
        </div>
    </div>

    <!-- 10 B·∫¢N GHI M·ªöI NH·∫§T -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">üìã 10 B·∫¢N GHI M·ªöI NH·∫§T</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>mm</th>
                            <th>PE</th>
                            <th>L∆∞u l∆∞·ª£ng</th>
                            <th>C·∫•p</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in (ViewBag.Data as List<KttvKvtnWeb.Models.CwtDomua>).Take(10))
                        {
                            DateTime dt;
                            if (!DateTime.TryParse(item.Thoigian?.ToString(), out dt)) dt = DateTime.MinValue;

                            <tr>
                                <td>@(dt != DateTime.MinValue ? dt.ToString("dd/MM HH:mm") : item.Thoigian)</td>
                                <td class="fw-bold">@item.Luongmua</td>
                                <td>@item.Pe</td>
                                <td>@item.Luuluong</td>
                                <td>
                                    <span class="badge" style="background-color:@GetRainColor(item.Luongmua); color:white;">
                                        @GetRainLevel(item.Luongmua)
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        @if (ViewBag.Data != null && ViewBag.Data.Count > 0)
        {
            <text>
            const lineData = @Html.Raw(JsonConvert.SerializeObject(ViewBag.Data));
            const lineLabels = lineData.map(x => new Date(x.Thoigian).toLocaleString('vi-VN'));
            const lineValues = lineData.map(x => x.Luongmua);

            // M√†u ƒëi·ªÉm ƒë·ªìng b·ªô v·ªõi badge & ch√∫ th√≠ch
            const lineColors = lineData.map(x => {
                const rain = x.Luongmua;
                if (rain > 100) return '#FF0000';
                if (rain > 50) return '#FFA500';
                if (rain > 10) return '#32CD32';
                if (rain > 0) return '#87CEFA';
                return '#2F4F4F';
            });

            const ctxLine = document.getElementById('lineChart').getContext('2d');
            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: lineLabels,
                    datasets: [{
                        label: 'L∆∞·ª£ng m∆∞a (mm)',
                        data: lineValues,
                        borderColor: '#0277bd',
                        backgroundColor: 'rgba(2, 119, 189, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: lineColors,
                        pointRadius: 6
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
            </text>
        }
    </script>
}
