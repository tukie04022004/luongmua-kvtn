@{
    ViewData["Title"] = "T·ªïng quan l∆∞·ª£ng m∆∞a";
}

<div class="text-center mb-4">
    <h2 class="text-primary fw-bold">
        üåß T·ªîNG QUAN L∆Ø·ª¢NG M∆ØA KHU V·ª∞C (C·∫≠p nh·∫≠t: @DateTime.Now.ToString("dd/MM/yyyy HH:mm"))
    </h2>
    <button class="btn btn-success btn-sm" onclick="location.reload()">üîÑ L√†m m·ªõi d·ªØ li·ªáu</button>
</div>

<!-- Bi·ªÉu ƒë·ªì c·ªôt -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white fw-bold">
        BI·ªÇU ƒê·ªí L∆Ø·ª¢NG M∆ØA M·ªöI NH·∫§T T·∫†I 20 TR·∫†M (mm)
    </div>
    <div class="card-body">
        <canvas id="rainChart" height="100"></canvas>
    </div>
</div>

<!-- B·∫£ng ch√∫ th√≠ch -->
<div class="card mb-4">
    <div class="card-header fw-bold" style="background-color:#343a40; color:white;">
        üåß CH√ö TH√çCH M·ª®C L∆Ø·ª¢NG M∆ØA
    </div>
    <div class="card-body p-0">
        <table style="width:100%; border-collapse: collapse; text-align:center;">
            <thead>
                <tr>
                    <th style="padding:8px; border:1px solid #ccc;">M√†u</th>
                    <th style="padding:8px; border:1px solid #ccc;">M·ª©c m∆∞a (mm)</th>
                    <th style="padding:8px; border:1px solid #ccc;">M√¥ t·∫£ & C·∫£nh b√°o</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background-color:#2F2F2F; color:white;">
                    <td style="padding:8px; border:1px solid #ccc;">Kh√¥ng m∆∞a</td>
                    <td style="padding:8px; border:1px solid #ccc;">0 mm</td>
                    <td style="padding:8px; border:1px solid #ccc;">B√¨nh th∆∞·ªùng</td>
                </tr>
                <tr style="background-color:#87CEFA; color:black;">
                    <td style="padding:8px; border:1px solid #ccc;">M∆∞a nh·ªè</td>
                    <td style="padding:8px; border:1px solid #ccc;">0 - 10 mm</td>
                    <td style="padding:8px; border:1px solid #ccc;">Nh·∫π, kh√¥ng ·∫£nh h∆∞·ªüng</td>
                </tr>
                <tr style="background-color:#32CD32; color:black;">
                    <td style="padding:8px; border:1px solid #ccc;">M∆∞a v·ª´a</td>
                    <td style="padding:8px; border:1px solid #ccc;">10 - 50 mm</td>
                    <td style="padding:8px; border:1px solid #ccc;">Ng·∫≠p c·ª•c b·ªô</td>
                </tr>
                <tr style="background-color:#FFA500; color:black;">
                    <td style="padding:8px; border:1px solid #ccc;">M∆∞a to</td>
                    <td style="padding:8px; border:1px solid #ccc;">50 - 100 mm</td>
                    <td style="padding:8px; border:1px solid #ccc;">C·∫£nh b√°o ng·∫≠p, l≈© nh·ªè</td>
                </tr>
                <tr style="background-color:#FF0000; color:white;">
                    <td style="padding:8px; border:1px solid #ccc;">M∆∞a r·∫•t to</td>
                    <td style="padding:8px; border:1px solid #ccc;">> 100 mm</td>
                    <td style="padding:8px; border:1px solid #ccc;">Nguy c∆° l≈© qu√©t, s·∫°t l·ªü</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- B·∫£n ƒë·ªì OpenStreetMap -->
<div class="card">
    <div class="card-header bg-info text-white fw-bold">
        üó∫ B·∫¢N ƒê·ªí TR·∫†M QUAN TR·∫ÆC L∆Ø·ª¢NG M∆ØA (Click marker ƒë·ªÉ xem chi ti·∫øt)
    </div>
    <div class="card-body">
        <div id="map" style="height:600px; border-radius:8px;"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <script>
        // Bi·ªÉu ƒë·ªì c·ªôt
        var ctx = document.getElementById('rainChart').getContext('2d');
        var chartData = @Html.Raw(ViewBag.ChartData);
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(x => x.tentram),
                datasets: [{
                    label: 'L∆∞·ª£ng m∆∞a (mm)',
                    data: chartData.map(x => x.luongmua),
                    backgroundColor: chartData.map(x => x.color),
                    borderColor: '#01579b',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'L∆∞·ª£ng m∆∞a: ' + context.parsed.y + ' mm';
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'mm' } }
                }
            }
        });

        // B·∫£n ƒë·ªì OSM v·ªõi marker m√†u ƒë·ªìng b·ªô
        var map = L.map('map').setView([10.762, 106.660], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var stations = @Html.Raw(ViewBag.Stations);
        stations.forEach(function(s) {
            var marker = L.circleMarker([parseFloat(s.lat), parseFloat(s.lng)], {
                radius: 10,
                fillColor: s.color,
                color: '#ffffff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);

            marker.bindPopup(
                `<b>${s.tentram}</b><br>${s.diachi}<br><b>L∆∞·ª£ng m∆∞a: ${s.luongmua} mm</b><br>Th·ªùi gian: ${s.thoigian}`
            );
        });
    </script>
}
